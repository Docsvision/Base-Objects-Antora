= Добавить электронную подпись

.Чтобы подписать карточку "Документ" электронной подписью:
. Откройте карточку _Документ_, которую требуется подписать.
. На ленте карточки нажмите на кнопку:
+
--
* image:buttons/sign.png[Красная печать с плюсом] -- чтобы выполнить подписание.
* *Подписать* -- чтобы дополнительно настроить подписание.
--
+
[lowerroman]
.Чтобы дополнительно настроить подписание:
.. Нажмите на кнопку *Подписать*.
+
.Меню кнопки "Подписать"
image::document-sign-button-menu.png[Меню кнопки "Подписать"]
+
.. Выберите команду _Варианты_. Будет открыто окно _Варианты подписи_.
.. В раскрывающемся списке _Метка_ выберите метку из числа доступных для вида. Настройка меток производится в _Справочника меток подписей_.
.. В раскрывающемся списке _За кого_ выберите сотрудника, от имени которого будет подписана карточка.
+
Данное поле активно, если в _Справочнике сотрудников_ текущий пользователь указан хотя бы для одного сотрудника заместителем с правом подписи.
+
.. После выбора сотрудника становится активным дополнительное поле _Текст подтверждения ЭЦП_. По умолчанию в поле подставляется доступное для изменения значение настройки _Текст подтверждения ЭЦП_, заданное в карточке сотрудника для соответствующего замещаемого.
+
.Настройка варианта подписи
image::document-sign-options.png[Настройка варианта подписи]
+
. Выберите сертификат подписи и нажмите на кнопку *OK*, или нажмите на кнопку *Простая подпись*.
+
.Выбор сертификата ЭП при подписании
image::document-sign-certificate.png[Выбор сертификата ЭП при подписании]
+
.Окно выбора сертификата не отображается, если:
.. У пользователя один сертификат, и он указан в _Справочнике сотрудников_ (будет использован этот сертификат).
.. У пользователя нет сертификатов для подписания (будет использована простая подпись).
.. В _Справочнике сотрудников_ установлен параметр `*Не показывать окно выбора сертификата*`. В этом случае вместо окна выбора сертификата появится сообщение: `Будет выполнено подписание с помощью сертификата`.
+
После подтверждения операции подписания будет наложена усиленная электронная подпись с использованием указанного сертификата. Если сертификат, указанный в _Справочнике сотрудников_, просрочен, или не удалось проверить его состояние, появится сообщение: `Не удалось выполнить подписание с использованием сертификата. Сертификат недействителен или же его состояние не может быть проверено. Обратитесь к администратору системы` и подпись наложена не будет.
+
При подписании с помощью сертификата в зависимости от настроек системы {dv} и наличия на компьютере требуемого ПО формируется <<simple-signature,простая>> или <<certificate-signature,усиленная>> подпись.
+
При подписании _основных_ файлов, приложенных к карточке, формируется одна подпись, в которую включается по отдельной части для каждого из основных файлов. Номер версии каждого основного файла отображается в его части подписи.
+
[NOTE]
====
Если это предусмотрено настройками вида карточек, функция подписания вызывается автоматически при выполнении определённой операции с документом. Электронная подпись формируется в соответствии с настройками подписания, заданными для вида карточек в _Справочника видов карточек_. При выполнении автоматического подписания будет выведен диалог выбора сертификата в соответствии с условиями, приведенными в п. 3.
====

[#attorney]
== Использовать доверенность

В диалоге подписания можно выбрать МЧД в области _Использовать доверенность_. При открытии окна выбора сертификата система отправляет запрос к "xref:engineer::config-attorney.adoc#algorithm[Сервису подбора МЧД]", если сервис смог подобрать доверенность для сотрудника, её можно выбрать из таблицы под списком сертификатов.

Если для сотрудника отсутствуют подходящие доверенности, область _Использовать доверенность_ будет скрыта. Выбор доверенности также будет недоступен при подписании простой подписью.

.Выбор доверенности при подписании
image::document-sign-certificate-m4d.png[Выбор доверенности при подписании]

В поле выбора доверенности по умолчанию отображается первая доверенность. Сортировка идёт по возрастанию: сначала по полю _Доверитель_, потом по _Дате совершения доверенности_, затем по _Номеру доверенности_. +
Значения полей получаются из соответствующих полей СКД.

.Кнопка "ОК" для выбора доверенности:
* Доступна, если доверенность не требуется.
* Доступна, если доверенность выбрана.
* Доступна, но вместо поля _Использовать доверенность_ показывает предупреждающее сообщение `Подходящие доверенности отсутствуют`, если нет подходящей доверенности, но для данного вида документа доверенность *Желательна*.
* Кнопка недоступна, если подходящие доверенности отсутствуют, и для данного вида документа доверенность *Обязательна*. Вместо области _Использовать доверенность_ отображается предупреждение `Подходящие доверенности отсутствуют`.

[#simple-signature]
== Простая подпись

Наложить простую подпись может любой пользователь, который работает с системой {dv}, используя учетную запись Windows.

Подписью также подписываются атрибуты, настроенные для вида карточки самого документа и атрибуты выполненной над документом операции редактирования. В зависимости от настроек, подписаны могут быть как основные, так и дополнительные файлы карточки.

Например, подпись может быть наложена при выполнении операции регистрации документа, для подтверждения конкретным сотрудником факта регистрации, с сохранением времени выполнения данной операции.

При экспорте документа, простая подпись (в отличие от усиленной) не может быть экспортирована.

[#certificate-signature]
== Усиленная подпись

Наложить усиленную подпись может пользователь, обладающий действующим сертификатом подписи.

При наложении будут подписаны атрибуты, настроенные для вида карточки документа и атрибуты операции редактирования, выполненной над документом. В зависимости от настроек, подписаны могут быть как основные, так и дополнительные файлы карточки.

Документ с наложенной усиленной подписью может при необходимости быть xref:document/export.adoc[экспортирован] в формат `.p7s`. Пользователю доступен выбор предпочтительного способа экспорта (в одном или в разных файлах с документом), а также выбор для экспортирования определённых подписей из числа доступных.

Файлы с наложенной подписью (сохранённые как в одном, так и в разных файлах) могут добавляться в карточки документов в качестве вложений. Импорт подписи выполняется после дополнительного подтверждения со стороны пользователя. Если подписи сохранены в разных файлах, дополнительно выполняется проверка на соответствие файла документа и файла подписи.

Сертификат представляет собой электронный документ (файл) типа `.sc` (Security Certificate), который связывает данные для проверки электронных подписей с определённым лицом и подтверждает идентичность данного лица.

Один пользователь системы {dv} может быть владельцем как одного, так и нескольких сертификатов подписи. Конкретный сертификат выбирается пользователем на этапе выполнения команды подписания непосредственно из карточки. Сертификат по умолчанию должен быть указан в карточке сотрудника в _Справочнике сотрудников_.

.Сертификат подписи пользователя
image::user-sign-cert.png[Сертификат подписи пользователя]

Валидность обычного сертификата проверяется по текущему времени клиента. Если срок действия сертификата на момент подписания истек, сертификат будет считаться недействительным. Когда пользователь попытается подписать документ, записи в окне выбора сертификата подписи будут подсвечены розовым, а кнопка *ОК* при выборе записи станет неактивной.

В системе {dv} также могут использоваться квалифицированные сертификаты подписей с поддержкой стандартов TSP/OCSP. Если такой сертификат доступен, в состав подписи вместо времени клиента будет включён штамп времени, полученный от сервера _Службы штампов времени_, а также атрибуты, настроенные в системе.

В случае успешного подписания документа или операции, в соответствующем журнале будет прописываться как дата/время из запрошенного штампа, так и время выполнения операции подписания. Валидность подписей стандарта TSP/OCSP проверяется на момент времени, указанный в штампе, даже если срок сертификата на текущий момент истек.

Если на момент подписания сертификат был действующим, подпись будет считаться валидной даже после истечения срока действия сертификата (как обычного, так и с поддержкой стандартов TSP/OCSP). В журнале подписей будет отображена информация об окончании действия сертификата.
